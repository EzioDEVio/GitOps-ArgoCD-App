name: Build, Test, and SonarQube Analysis

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Check Out Repo
      uses: actions/checkout@v2

    - name: Set Up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install Dependencies
      run: npm install

    - name: Run Tests with Coverage
      run: npm test  # This runs Jest with coverage

    - name: Upload Coverage to SonarQube
      run: |
        docker run \
          --rm \
          -e SONAR_HOST_URL=${{ secrets.SONAR_HOST_URL }} \
          -e SONAR_LOGIN=${{ secrets.SONAR_TOKEN }} \
          -v "${{ github.workspace }}:/usr/src" \
          sonarsource/sonar-scanner-cli \
          -Dsonar.projectKey=GitOps-ArgoCD-App \
          -Dsonar.sources=/usr/src \
          -Dsonar.javascript.lcov.reportPaths=/usr/src/coverage/lcov.info \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
